<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <title>Points on a map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="map_styles.css">
  </head>
  <body>
      <!-- Where the map is injected -->
    <div id='map'></div>

    <!-- Where the transaction data is displayed on zoom >= 6 -->
    <div class='transactionInfo toggle-off'>
        <div>
            <span id="actor"></span> <strong id="action"></strong> <span id="target"></span>
        </div>
        <div>Date: <span id="date"></span></div>
        <div>Message: <span id="message"></span></div>
    </div>

    <!-- Bottom Right Zoom level display -->
    <div class="zoomInfo">
        <div>Zoom: <strong id='zoom'>Loading...</strong></div>
    </div>

    <!-- Initial modal popup to explain website/zoom features -->
    <div id="myModal" class="modal">

        <div class="modal-content">

          <div class='modal-header'>
            <span class="close">&times;</span>
            <h1>VenmoViz</h1>
          </div>

          <div class='modal-body'>
            <p>This is a visualization of ~1 million Venmo transactions from ~1.5 million unique users. Each edge represents a transaction, and each node represents a user.
                I used a fraction of <a href="https://github.com/sa7mon/venmo-data">this</a> dataset to build the graph.
            </p>
            <p>Because of the large amount of data, certain features of the graph are only available at higher zoom levels:</p>
            <ul id="modal-list">
                <li>At a zoom larger than 5, you may see edges</li>
                <li>At a zoom larger 6, you may see transaction details by hovering on an edge</li>
                <li>At a zoom larger than 7, you may click on a node to get redirected to that Venmo user's recent transactions</li>
                <li>At a zoom larger than 10, the names of the users become visible</li>
            </ul>
            <p>If you are interested in building your own large network graph, a detailed explanation on how this was made may be found <a href="">here.</a> </p>
          </div>

          <div class='modal-footer'>
            <h4>Happy Exploring!</h4>
          </div>
        </div>
    </div>

    <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoia2FybG8yMSIsImEiOiJjazU2M292cHYwMzhmM210NTNwcjFraTg1In0.vVyJI1XcfhRToXiW_zpduQ'; 
    let map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/karlo21/ck5d5g89s038j1io3ks740z7y', 
      center: [0, 0],
      zoom: 3.01,
      maxZoom: 15,
      minZoom: 3
    });
    map.addControl(new mapboxgl.NavigationControl());

    //fields that will get injected into/displayed on mouseover of transaction edges (when zoom >= 6)
    let actorField = document.getElementById('actor');
    let actionField = document.getElementById('action');
    let targetField = document.getElementById('target');
    let dateField = document.getElementById('date');
    let messageField = document.getElementById('message');
    let transactionDiv = document.querySelector('.transactionInfo');
    let zoomField = document.getElementById('zoom');

    map.on('load', () => {

        zoomField.textContent =  map.getZoom().toFixed(2);

        map.on('click', '1m-nodes (1)', function(e) {
            if(map.getZoom() >= 7){
                let url = `https://venmo.com/${e.features[0].properties.username}`;
                window.open(url, "_blank");
            }
        });

        map.on('mousemove', '1m-nodes (1)', function(e) {
            if(map.getZoom() >= 7){
                map.getCanvas().style.cursor = 'pointer';
            }
        });

        map.on('mouseleave', '1m-nodes (1)', function(e){
            if(map.getZoom() >= 7){
                map.getCanvas().style.cursor = '';
            }
        });

        map.on('mousemove', 'mod-1m', function(e) {

            if(map.getZoom() >= 6){
                let props = e.features[0].properties
                transactionDiv.classList.remove('toggle-off');
                transactionDiv.classList.add('toggle-on');
                map.getCanvas().style.cursor = 'pointer';
                actorField.textContent = props.actor_name;
                actionField.textContent = props.action;
                targetField.textContent = props.target_name;
                dateField.textContent = props.date;
                messageField.textContent = props.message;
            }
        });

        map.on('mouseleave', 'mod-1m', function(){
            transactionDiv.classList.remove('toggle-on');
            transactionDiv.classList.add('toggle-off');
            map.getCanvas().style.cursor = '';
            actorField.textContent = '';
            actionField.textContent = '';
            targetField.textContent = '';
            dateField.textContent = '';
            messageField.textContent = '';
        });

        map.on('zoomend', function(e){
            zoomField.textContent = map.getZoom().toFixed(2);
        });
    });

    let modal = document.getElementById("myModal");
    // Get the <span> element that closes the modal
    let closeSpan = document.querySelector(".close");

    //install modal extension listeners
    closeSpan.onclick = function() {
        modal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    </script>
    
  </body>
</html>